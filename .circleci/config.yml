version: 2.1

orbs:
  python: circleci/python@2.1.1
  docker: circleci/docker@2.4.0
  pack: buildpacks/pack@0.2.0

executors:
  knative-python:
    docker:
      - image: cimg/python:3.11
    working_directory: ~/project

jobs:
  picard_job:
    docker:
      - image: broadinstitute/picard:3.1.1
    steps:
      - checkout
      - run:
          name: Check Picard version
          command: picard --version
  test:
    executor: knative-python
    steps:
      - checkout

      # Install uv
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV

      # Restore uv cache (very important for speed)
      - restore_cache:
          keys:
            - uv-cache-{{ checksum "uv.lock" }}
            - uv-cache-

      # Install Python (optional but recommended)
      - run:
          name: Ensure Python version
          command: |
            uv python install 3.12
            uv python pin 3.12

      # Sync dependencies
      - run:
          name: Install dependencies
          command: |
            uv sync --dev

      # Save cache
      - save_cache:
          key: uv-cache-{{ checksum "uv.lock" }}
          paths:
            - ~/.cache/uv
            - .venv

      # Run tests
      - run:
          name: Run tests
          command: |
            uv run pytest

  build-and-push:
    docker:
      - image: cimg/base:stable
    environment:
      IMAGE_NAME: knative-function
    steps:
      - checkout

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Install Knative func CLI
          command: |
            curl -L https://github.com/knative/func/releases/latest/download/func_linux_amd64 \
              -o /usr/local/bin/func
            chmod +x /usr/local/bin/func

      - run:
          name: Build function container
          command: |
            func build

      - run:
          name: Push image
          command: |
            echo "$DOCKER_PASSWORD" | docker login \
              -u "$DOCKER_USERNAME" --password-stdin
            func push

workflows:
  version: 2
  build-test-deploy:
    jobs:
      - test
      - build-and-push:
          requires:
            - test
          filters:
            branches:
              only: main
  picard_job:
    jobs:
      - picard_job
  main:
    jobs:
      - pack/build:
          image-name: cefunctions
          builder: s2i
